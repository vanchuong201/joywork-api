// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - Core user entity
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  name          String?
  phone         String?
  emailVerified Boolean  @default(false)
  role          UserRole @default(USER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  profile                 UserProfile?
  companies               CompanyMember[]
  applications            Application[]
  messages                Message[]
  follows                 Follow[]
  likes                   Like[]
  jobFavorites            JobFavorite[]
  posts                   Post[]
  postAuditLogs           PostAuditLog[]
  postReactions           PostReaction[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]
  postFavorites           PostFavorite[]
  socialAccounts          UserSocialAccount[]
  tickets                 CompanyTicket[]          @relation("TicketApplicant")
  ticketMessages          CompanyTicketMessage[]
  sentInvitations         CompanyInvitation[]      @relation("SentInvitations")

  @@map("users")
}

// Email Verification Token
model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("email_verification_tokens")
}

// Password Reset Token
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

enum UserRole {
  USER
  ADMIN
}

// UserProfile - Extended user information
model UserProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  avatar    String?
  headline  String?
  bio       String?
  skills    String[]
  cvUrl     String?
  location  String?
  website   String?
  linkedin  String?
  github    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// Company model
model Company {
  id            String       @id @default(cuid())
  name          String
  legalName     String?
  slug          String       @unique
  tagline       String?
  description   String?
  logoUrl       String?
  coverUrl      String?
  website       String?
  location      String?
  industry      String?
  size          CompanySize?
  foundedYear   Int?
  headcount     Int?
  headcountNote String?
  metrics       Json?
  profileStory  Json?
  highlights    Json?
  isVerified    Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  members     CompanyMember[]
  posts       Post[]
  jobs        Job[]
  follows     Follow[]
  tickets     CompanyTicket[]
  invitations CompanyInvitation[]

  @@map("companies")
}

enum CompanySize {
  STARTUP
  SMALL
  MEDIUM
  LARGE
  ENTERPRISE
}

// CompanyMember - Many-to-many relationship between User and Company
model CompanyMember {
  id        String            @id @default(cuid())
  userId    String
  companyId String
  role      CompanyMemberRole @default(MEMBER)
  joinedAt  DateTime          @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("company_members")
}

enum CompanyMemberRole {
  OWNER
  ADMIN
  MEMBER
}

// Post model - Company posts (Story posts)
model Post {
  id          String         @id @default(cuid())
  companyId   String
  createdById String?
  title       String
  content     String
  excerpt     String?
  coverUrl    String?
  type        PostType       @default(STORY)
  visibility  PostVisibility @default(PUBLIC)
  publishedAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  company   Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy User?          @relation(fields: [createdById], references: [id], onDelete: SetNull)
  likes     Like[]
  postReactions PostReaction[]
  images    PostImage[]
  auditLogs PostAuditLog[]
  favorites PostFavorite[]
  postJobs  PostJob[]
  hashtags  PostHashtag[]

  @@map("posts")
}

// Post images (gallery)
model PostImage {
  id         String  @id @default(cuid())
  postId     String
  url        String
  storageKey String?
  width      Int?
  height     Int?
  order      Int     @default(0)

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("post_images")
}

model PostAuditLog {
  id        String          @id @default(cuid())
  postId    String?
  actorId   String?
  action    PostAuditAction
  metadata  Json?
  createdAt DateTime        @default(now())

  post  Post? @relation(fields: [postId], references: [id], onDelete: SetNull)
  actor User? @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@map("post_audit_logs")
}

// Link jobs to posts
model PostJob {
  id        String   @id @default(cuid())
  postId    String
  jobId     String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([postId, jobId])
  @@index([jobId])
  @@index([postId])
  @@map("post_jobs")
}

// Global hashtags for posts
model Hashtag {
  id        String        @id @default(cuid())
  slug      String        @unique
  label     String
  createdAt DateTime      @default(now())

  // Relations
  posts PostHashtag[]

  @@map("hashtags")
}

// Link hashtags to posts (explicit many-to-many with timestamps)
model PostHashtag {
  id        String   @id @default(cuid())
  postId    String
  hashtagId String
  createdAt DateTime @default(now())

  // Relations
  post    Post    @relation(fields: [postId], references: [id], onDelete: Cascade)
  hashtag Hashtag @relation(fields: [hashtagId], references: [id], onDelete: Cascade)

  @@unique([postId, hashtagId])
  @@index([hashtagId])
  @@index([postId])
  @@map("post_hashtags")
}

enum PostAuditAction {
  CREATE
  UPDATE
  DELETE
  PUBLISH
  UNPUBLISH
}

enum PostType {
  STORY
  ANNOUNCEMENT
  EVENT
}

enum PostVisibility {
  PUBLIC
  PRIVATE
  DRAFT
}

// Job model - Job postings
model Job {
  id                  String          @id @default(cuid())
  companyId           String
  title               String
  description         String
  requirements        String?
  responsibilities    String?
  benefits            String?
  location            String?
  remote              Boolean         @default(false)
  salaryMin           Int?
  salaryMax           Int?
  currency            String          @default("VND")
  employmentType      EmploymentType  @default(FULL_TIME)
  experienceLevel     ExperienceLevel @default(MID)
  skills              String[]
  tags                String[]
  applicationDeadline DateTime?
  isActive            Boolean         @default(true)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  // Relations
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  applications Application[]
  favorites    JobFavorite[]
  PostJob      PostJob[]

  @@map("jobs")
}

// Job favorites - Saved jobs
model JobFavorite {
  id        String   @id @default(cuid())
  userId    String
  jobId     String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@map("job_favorites")
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  FREELANCE
}

enum ExperienceLevel {
  ENTRY
  JUNIOR
  MID
  SENIOR
  LEAD
  EXECUTIVE
}

// Application model - Job applications
model Application {
  id          String            @id @default(cuid())
  jobId       String
  userId      String
  status      ApplicationStatus @default(PENDING)
  coverLetter String?
  resumeUrl   String?
  notes       String?
  appliedAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  job      Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([userId, jobId])
  @@map("applications")
}

enum ApplicationStatus {
  PENDING
  REVIEWING
  SHORTLISTED
  REJECTED
  HIRED
}

// Message types for inbox
enum MessageType {
  TEXT
  FILE
  IMAGE
}

// Message model - Inbox messages
model Message {
  id            String      @id @default(cuid())
  applicationId String
  senderId      String
  content       String
  messageType   MessageType @default(TEXT)
  fileUrl       String?
  isRead        Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  sender      User        @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@map("messages")
}

// Follow model - User follows Company
model Follow {
  id        String   @id @default(cuid())
  userId    String
  companyId String
  createdAt DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("follows")
}

// Like model - User likes Post
model Like {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@map("likes")
}

enum ReactionType {
  JOY
  TRUST
  SKEPTIC
}

// Post reactions - Multi-reaction support
model PostReaction {
  id        String       @id @default(cuid())
  userId    String
  postId    String
  type      ReactionType
  createdAt DateTime     @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId], name: "userId_postId")
  @@index([postId])
  @@map("post_reactions")
}
// Post favorites - Saved posts
model PostFavorite {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@map("post_favorites")
}

enum TicketStatus {
  OPEN
  RESPONDED
  CLOSED
}

model CompanyTicket {
  id                    String       @id @default(cuid())
  companyId             String
  applicantId           String
  title                 String
  status                TicketStatus @default(OPEN)
  applicantLastViewedAt DateTime?
  companyLastViewedAt   DateTime?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  company   Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  applicant User                   @relation("TicketApplicant", fields: [applicantId], references: [id], onDelete: Cascade)
  messages  CompanyTicketMessage[]

  @@index([companyId])
  @@index([applicantId])
  @@index([status])
  @@map("company_tickets")
}

model CompanyTicketMessage {
  id        String   @id @default(cuid())
  ticketId  String
  senderId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ticket CompanyTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender User          @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([senderId])
  @@map("company_ticket_messages")
}

model CompanyInvitation {
  id        String            @id @default(cuid())
  email     String
  role      CompanyMemberRole
  token     String            @unique
  companyId String
  inviterId String
  expiresAt DateTime
  createdAt DateTime          @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inviter User    @relation("SentInvitations", fields: [inviterId], references: [id], onDelete: Cascade)

  @@unique([companyId, email])
  @@index([token])
  @@map("company_invitations")
}

// Social login accounts (Google, Facebook, ...)
model UserSocialAccount {
  id         String   @id @default(cuid())
  userId     String
  provider   String   // e.g. "google", "facebook"
  providerId String   // sub/id from provider
  email      String?  // email from provider (if available)
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@map("user_social_accounts")
}
